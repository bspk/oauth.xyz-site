(self.webpackChunkoauth_xyz=self.webpackChunkoauth_xyz||[]).push([[274],{707:function(e,t,n){"use strict";n.r(t),n.d(t,{_frontmatter:function(){return l},default:function(){return d}});var a=n(9756),i=(n(7294),n(4983)),o=n(5127),r=n(952),s=n(3751),c=n(5444),l={},h={_frontmatter:l},u=o.Z;function d(e){var t=e.components,n=(0,a.Z)(e,["components"]);return(0,i.kt)(u,Object.assign({},h,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)(s.Z,{title:"Interaction",keywords:["oauth","authorization","security"],mdxType:"SEO"}),(0,i.kt)("h1",null,"Interaction"),(0,i.kt)("p",null,"During a transaction, the AS will often require interaction from a user. This user can be the same person running the client software, or it could be another party who's not necessarily available. In the request, the client instance tells the AS how it is able to interact with the user running the software by declaring how it can start an interaction, how it can finish an interaction, and any other interaction-based hints that might help the AS. "),(0,i.kt)("h2",null,"Start Modes"),(0,i.kt)("p",null,"The client can indicate one or more modes to ",(0,i.kt)("inlineCode",{parentName:"p"},"start")," an interaction. "),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("inlineCode",{parentName:"li"},"redirect")," mode is used when the client instance is capable of opening a browser on the same device for the user to interact with the AS, or otherwise directing the user to an arbitrary URL."),(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("inlineCode",{parentName:"li"},"app")," mode is used when the client instance can launch an application from the same device the user is interacting with. The way that application communicates with the AS is not defined by GNAP."),(0,i.kt)("li",{parentName:"ul"},"The ",(0,i.kt)("inlineCode",{parentName:"li"},"user_code")," mode is used when the client instance can communicate an out-of-band code to the user for the user to provide to the AS (usually by typing it in).")),(0,i.kt)("p",null,"The client indicates these in the interaction request's ",(0,i.kt)("inlineCode",{parentName:"p"},"start")," field by listing out the modes in an array. The AS evaluates this array and determines which, if any, of the modes are appropriate for the request. "),(0,i.kt)("p",null,"In the future, other start modes could indicate things like allowing the client to send a request to a digital wallet or sending a message to the user through another communication channel."),(0,i.kt)("h2",null,"Finish Modes"),(0,i.kt)("p",null,"In addition, the client can indicate how it can receive a signal from the AS once interaction is completed. Currently, there are two methods of getting a response:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"The client instance can set a ",(0,i.kt)("inlineCode",{parentName:"li"},"redirect")," method including a URL that the AS can send the user back to when done interacting"),(0,i.kt)("li",{parentName:"ul"},"The client instance can set a ",(0,i.kt)("inlineCode",{parentName:"li"},"push")," method including a URL that the AS can send an HTTP message to when the user is done interacting")),(0,i.kt)("p",null,"The messages from the AS to any of these finish methods will contain an ",(0,i.kt)("inlineCode",{parentName:"p"},"interact_ref")," parameter that the client instance presents to the AS when it ",(0,i.kt)(c.rU,{to:"/continue",mdxType:"Link"},"continues the request at the AS"),"."),(0,i.kt)("p",null,"The client can also poll the continuation endpoint as well, in which case a client wouldn't specify a finish mode. However, a client that's waiting for a response from interaction shouldn't poll before that interaction signal is completed because it won't have the interaction reference returned. A client that just wants to poll should leave the interaction ",(0,i.kt)("inlineCode",{parentName:"p"},"finish")," field off of its request."),(0,i.kt)("h3",null,"Interaction Reference Hash"),(0,i.kt)("p",null,"In addition to the interaction reference, the AS will calculate a cryptographic hash, which is later verified by the client instance. The hash is created by first concatenating the following values with a newline ",(0,i.kt)("inlineCode",{parentName:"p"},"\\n")," between them:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"the ",(0,i.kt)("inlineCode",{parentName:"li"},"nonce")," value sent by the client instance in the initial request's ",(0,i.kt)("inlineCode",{parentName:"li"},"finish")," section"),(0,i.kt)("li",{parentName:"ul"},"the ",(0,i.kt)("inlineCode",{parentName:"li"},"finish")," nonce value returned in the initial response"),(0,i.kt)("li",{parentName:"ul"},"the unique interaction reference value ",(0,i.kt)("inlineCode",{parentName:"li"},"interact_ref")," passed back to the client instance by the finish method"),(0,i.kt)("li",{parentName:"ul"},"the URL of the grant request endpoint, which identifies the AS the client instance is talking to")),(0,i.kt)("p",null,"For example, an input string could look like this:"),(0,i.kt)(r.Z,{language:"none",codeString:"VJLO6A4CAYLBXHTR0KRO\nMBDOFXG4Y5CVJCX821LH\n4IFWWIKYBC2PQ6U56NL1\nhttps://server.example.com/tx",mdxType:"Code"}),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},"There's no trailing newline on this string, but conveying that in an example is really difficult to do.")),(0,i.kt)("p",null,"The AS and client instance then pass this value through a hash function to get the interaction hash. By default, the finish methods use a ",(0,i.kt)("inlineCode",{parentName:"p"},"SHA3")," 512-bit hash over this data. The client instance can choose a different hash algorithm by sending a ",(0,i.kt)("inlineCode",{parentName:"p"},"hash_method")," parameter as part of the ",(0,i.kt)("inlineCode",{parentName:"p"},"finish")," object with a different registered hash value. If the AS can't honor the client instance's requested hash method, it has to fail the request from the start."),(0,i.kt)("h2",null,"UI Hints"),(0,i.kt)("p",null,"The client instance can also give some hints to the AS about how to handle the interaction. Currently, the client can only send a set of preferred UI locales, but in the future other information the client might know could be set here as well."),(0,i.kt)("h1",null,"Example Interaction Combinations"),(0,i.kt)("p",null,"While the different interaction modes can be mixed and matched to fit different needs, as shown on the ",(0,i.kt)(c.rU,{to:"/request",mdxType:"Link"},"request demo page"),", there are a number of common combinations that are worth discussing."),(0,i.kt)("h2",null,"Redirect with Callback"),(0,i.kt)("p",null,"In fully redirect based interaction, the client sends the user to an interactive page at the AS. The AS then sends the user back to the client with an HTTP redirect. "),(0,i.kt)("p",null,"To use this mode, the client's transaction request includes a section that includes a URI the client can receive requests at as well as a unique state value. "),(0,i.kt)(r.Z,{from:"client",to:"as",code:{interact:{start:["redirect"],finish:{method:"redirect",uri:"https://client.example.net/return/123455",nonce:"VJLO6A4CAYLBXHTR0KRO"}}},mdxType:"Code"}),(0,i.kt)("p",null,"The URI in the finish method must be reachable from the user's system browser, and can be any ",(0,i.kt)("inlineCode",{parentName:"p"},"https")," URL, an ",(0,i.kt)("inlineCode",{parentName:"p"},"http")," URL for a local-to-the-device host, or a service-specific URI that the user's browser can open. The ",(0,i.kt)("inlineCode",{parentName:"p"},"nonce")," must be a unique value for each transaction and cannot be re-used. The ",(0,i.kt)("inlineCode",{parentName:"p"},"nonce")," value is opaque to the AS and should be random. The client remembers this ",(0,i.kt)("inlineCode",{parentName:"p"},"nonce")," value and associates it with the current user. For a web server or other web application, this is generally done by placing it in the user's session. Native applications are generally considered single-user in nature, so the ",(0,i.kt)("inlineCode",{parentName:"p"},"nonce")," value is remembered in the application's current state."),(0,i.kt)("p",null,"When the AS determines that the client's request needs user interaction, it creates a unique interaction URL and returns it to the client in the transaction response. The AS associates this unique URI with the transaction. The interaction URI is for a user-facing page at the AS."),(0,i.kt)(r.Z,{from:"as",to:"client",code:{interact:{redirect:"https://server.example.com/interact/4CF492MLVMSW9MKMXKHQ",finish:"MBDOFXG4Y5CVJCX821LH"},continue:{access_token:{value:"80UPRY5NM33OMUKMKSKU"},uri:"https://server.example.com/continue"}},mdxType:"Code"}),(0,i.kt)("p",null,"Much like the callback URI, the interaction URI must be reachable from the user's system browser, and can be any ",(0,i.kt)("inlineCode",{parentName:"p"},"https")," URL, an ",(0,i.kt)("inlineCode",{parentName:"p"},"http")," URL for a local-to-the-device host, or a service-specific URI that the user's browser can open."),(0,i.kt)("p",null,"The client sends the user to the URL completely as-is, without adding any query parameters, fragments, paths, or other components. If the client is a web server, it can send the user to the remote site via an HTTP redirect."),(0,i.kt)(r.Z,{from:"client",to:"browser",language:"http",codeString:"HTTP 302 Found\nLocation: https://server.example.com/interact/4CF492MLVMSW9MKMXKHQ",mdxType:"Code"}),(0,i.kt)("p",null,"If the client is a mobile application, such as an Android app, it can launch the system browser for interaction."),(0,i.kt)(r.Z,{from:"client",to:"browser",language:"java",codeString:'Intent browserIntent = \n  new Intent(Intent.ACTION_VIEW, \n    Uri.parse("https://server.example.com/interact/4CF492MLVMSW9MKMXKHQ"));\nstartActivity(browserIntent);',mdxType:"Code"}),(0,i.kt)("p",null,"Obviously, any method including an embedded security tab such as used by the AppAuth implementation of OAuth 2 is also acceptable. The important thing is to get the current user to the AS, where they can start interacting."),(0,i.kt)("p",null,"Once at the AS, the AS can ask the user for authentication, and to authorize the application itself. The AS could prompt the user to provide additional claims or proofs however it sees fit, and this interaction is ultimately outside of the protocol."),(0,i.kt)("p",null,"When the AS has collected whatever input it needs from the user, it sends the user back to the client with an HTTP redirect. First, the AS creates a unique, unguessable interaction handle that the client can use in its subsequent interaction request. The AS also calculates an interaction hash as described above."),(0,i.kt)("p",null,"The AS creates the URL for the redirect by taking the ",(0,i.kt)("inlineCode",{parentName:"p"},"callback")," URI presented in the transaction request and appending two parameters: "),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"a unique interaction reference, in this example ",(0,i.kt)("inlineCode",{parentName:"li"},"4IFWWIKYBC2PQ6U56NL1")),(0,i.kt)("li",{parentName:"ul"},"the Base64 URL encoded ",(0,i.kt)("inlineCode",{parentName:"li"},"hash")," value calculated as described above")),(0,i.kt)(r.Z,{from:"as",to:"browser",language:"http",codeString:"HTTP 302 Found\nLocation: https://client.example.net/return/123455\n  ?hash=p28jsq0Y2KK3WS__a42tavNC64ldGTBroywsWxT4md_jZQ1R2HZT8BOWYHcLmObM7XHPAdJzTZMtKBsaraJ64A\n  &interact_ref=4IFWWIKYBC2PQ6U56NL1",mdxType:"Code"}),(0,i.kt)("p",null,"Note that the AS has to use a proper URL builder in case the client's callback URL contains existing query parameters, is lacking a root path, or has some other anomaly which would make it problematic to simply concatenate the strings. "),(0,i.kt)("p",null,"Once the AS creates the redirect response to the interaction request, the AS deletes or otherwise deactivates the interaction URL to prevent phishing and replay attacks. "),(0,i.kt)("p",null,"If the AS determines that there is an error during the interaction, its response depends on whether or not the incoming interaction URL was valid."),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"If the URL was valid and bound to an active transaction, the AS can return to the client as in a successful transaction. The client needs to send data to the transaction endpoint to determine next steps."),(0,i.kt)("li",{parentName:"ul"},"If the URL was not valid or not bound to an active transaction, the AS can only display to the user an error. Since the client has no way to inject a redirect URI alongside an invalid interaction request, there is reduced risk of open redirection attack.")),(0,i.kt)("p",null,"The client receives a request from the user's browser through the callback URL. If the client is a web server, this comes in as any other request. If the client is a native application, it usually receives the full URL from the system in whatever function it has registered to receive incoming requests. In any event, the client needs to parse the ",(0,i.kt)("inlineCode",{parentName:"p"},"hash")," parameter and compare its value to a hash calculated in the same way that the AS created it. Since both the AS and the client instance have access to all forms of input in the hash calculation, this is possible. If these hash values don't match the client returns an error to the user and does not call the AS again."),(0,i.kt)("p",null,"The client then sends a ",(0,i.kt)(c.rU,{to:"/continue",mdxType:"Link"},"continue request")," to the AS including the interaction reference as a parameter."),(0,i.kt)(r.Z,{from:"client",to:"as",code:{interact_ref:"4IFWWIKYBC2PQ6U56NL1"},mdxType:"Code"}),(0,i.kt)("p",null,"The AS looks up the transaction from a combination of the continuation request  and fetches the interaction reference associated with that transaction. The AS compares the presented reference to the stored interaction reference it appended to the client's callback with ",(0,i.kt)("inlineCode",{parentName:"p"},"interact"),". If they match, the AS continues processing as normal, likely issuing a token."),(0,i.kt)("h2",null,"User Code with Polling"),(0,i.kt)("p",null,"The user-code-based interaction is intended for clients that need to have the user use a secondary device of some kind to interact with the authorization server. Unlike the redirect based interaction, the client does not send the user to the AS directly. Instead, the client presents the user with a code and instructs the user to interact with the server. Meanwhile, the client polls the AS in the background until the transaction is approved."),(0,i.kt)("p",null,"The client starts this mode by sending a transaction request indicating that the user will interact with the AS through a secondary device. "),(0,i.kt)(r.Z,{from:"client",to:"as",code:{interact:{start:["user_code"]}},mdxType:"Code"}),(0,i.kt)("p",null,"When the AS determines that the client's request needs user interaction, it sends an interaction URI in the transaction response. The interaction URI is for a user-facing page at the AS, and this can be a static URI for this mode. The AS also includes a short user-facing code. This code must be random, short-lived, and easily typed by a user. It must be processed in a case-insensitive way, and should use characters that are unambiguous when displayed even at low resolution (e.g., not using both the ",(0,i.kt)("inlineCode",{parentName:"p"},"0")," (zero) and ",(0,i.kt)("inlineCode",{parentName:"p"},"O")," (letter O) characters as options)."),(0,i.kt)(r.Z,{from:"as",to:"client",code:{interact:{user_code:{url:"https://server.example.com/interact/device",code:"A1BC-3DFF"}},continue:{access_token:{value:"80UPRY5NM33OMUKMKSKU"},uri:"https://server.example.com/continue",wait:30}},mdxType:"Code"}),(0,i.kt)("p",null,"The client presents the user code to the user. The client also indicates to the user that they need to go to the interaction URL. As this is likely to be a static URL, the AS can provide a static link to this page. "),(0,i.kt)("p",null,"Once at the AS, the AS can ask the user for authentication, and to authorize the application itself. The AS could prompt the user to provide additional claims or proofs however it sees fit, and this interaction is ultimately outside of the protocol. At the interaction page, the user is prompted to enter the code from their device. The AS uses this code to look up the associated transaction to determine which actions it needs to take."),(0,i.kt)("p",null,"When the AS has collected whatever additional input it needs from the user, it displays to the user that they can return to their device and continue operation."),(0,i.kt)("blockquote",null,(0,i.kt)("p",{parentName:"blockquote"},'To completely close a session-fixation attack, we could require the AS to present another code to the user and have the user enter that into the client device. This only works on some kinds of devices, though, so it would need to be an option. Additionally, we might want to consider a kind of "secondary application" based interaction that isn\'t web-based, such as a CIBA login.')),(0,i.kt)("p",null,"Meanwhile, the client can poll the AS using the transaction handle to see if the user has authorized them yet. This request includes proofs of any keys that the client sent during the original transaction request."),(0,i.kt)(r.Z,{from:"client",to:"as",language:"http",codeString:'HTTP POST /continue\nAuthorization: GNAP 80UPRY5NM33OMUKMKSKU\nSignature-Input: gnap=("host" "authorization" "@request-target");created=1624564850\nSignature: gnap=:N0MynxZllMLOTxgl4PmgHZjQ+gwHKGFGeg6wD5FXKtMM25PfcU2eLVMF9rPuZTguUKnEbvrY7spXlJDZ0jrKZQ==:',mdxType:"Code"}),(0,i.kt)("p",null,"If the user has yet to approve the transaction, the AS sends back a response telling the client to wait. This response can contain a new continuation access token and URL which replace the client's original ones."),(0,i.kt)(r.Z,{from:"as",to:"client",code:{continue:{access_token:{value:"BI9QNW6V9W3XFJK4R02D"},uri:"https://server.example.com/continue",wait:30}},mdxType:"Code"}),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"wait")," parameter tells the client the number of integer seconds it must wait before polling again. The client can continue to poll in this manner until it receives either a token response or the user code times out and the client receives an error response."),(0,i.kt)("h2",null,"Redirect with Polling"),(0,i.kt)("p",null,"For some kinds of clients, it is possible to show the user a visual signal such as a QR code that the user can scan on a secondary device. This allows the client to send the user to an arbitrary URL but not receive a callback in the front channel, so polling is necessary. "),(0,i.kt)(r.Z,{from:"client",to:"as",code:{interact:{start:["redirect"]}},mdxType:"Code"}),(0,i.kt)("p",null,"As above, when the AS determines that the client's request needs user interaction, it creates a unique interaction URL and returns it to the client in the response. The AS associates this unique URI with the transaction. The interaction URI is for a user-facing page at the AS. Note that because the client did not send a ",(0,i.kt)("inlineCode",{parentName:"p"},"callback")," to the AS, the AS does not generate or return a ",(0,i.kt)("inlineCode",{parentName:"p"},"callback_server_nonce")," parameter."),(0,i.kt)(r.Z,{from:"as",to:"client",code:{interact:{redirect:"https://server.example.com/interact/4CF492MLVMSW9MKMXKHQ"},continue:{access_token:{value:"BI9QNW6V9W3XFJK4R02D"},uri:"https://server.example.com/continue",wait:30}},mdxType:"Code"}),(0,i.kt)("p",null,"The client then communicates this arbitrary URL to the user, perhaps using a QR code. "),(0,i.kt)("img",{src:"http://api.qrserver.com/v1/create-qr-code/?color=000000&bgcolor=FFFFFF&data=https%3A%2F%2Fserver.example.com%2Finteract%2F4CF492MLVMSW9MKMXKHQ&qzone=1&margin=0&size=200x200&ecc=L",alt:"qr code"}),(0,i.kt)("p",null,"While the client waits for the user to complete the interaction, it polls the AS using the transaction handle."),(0,i.kt)(r.Z,{from:"client",to:"as",language:"http",codeString:'HTTP POST /continue\nAuthorization: GNAP 80UPRY5NM33OMUKMKSKU\nSignature-Input: gnap=("host" "authorization" "@request-target");created=1624564850\nSignature: gnap=:N0MynxZllMLOTxgl4PmgHZjQ+gwHKGFGeg6wD5FXKtMM25PfcU2eLVMF9rPuZTguUKnEbvrY7spXlJDZ0jrKZQ==:',mdxType:"Code"}),(0,i.kt)("p",null,"If the user has yet to approve the transaction, the AS sends back a response telling the client to wait. This response contains a new transaction handle which replaces the client's original one."),(0,i.kt)(r.Z,{from:"as",to:"client",code:{continue:{access_token:{value:"ZI9QNW6V9W3XFJK4R02D"},uri:"https://server.example.com/continue",wait:30}},mdxType:"Code"}))}d.isMDXComponent=!0},5127:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});var a=n(7294),i=n(5444),o=(n(9499),[{name:"Request",link:"/request/"},{name:"Continue",link:"/continue/"},{name:"Response",link:"/response/"},{name:"Interaction",link:"/interaction/"},{name:"Keys",link:"/keys/"},{name:"Tokens",link:"/tokens/"},{name:"Discovery",link:"/discovery/"},{name:"Other Specs",link:"/specs/"},{name:"About",link:"/about/"}]),r=function(e){e.location;return a.createElement("div",{className:"header"},a.createElement("div",{className:"wrapper"},a.createElement("h1",{style:{margin:0}},a.createElement(i.rU,{to:"/",style:{color:"white",textDecoration:"none"}},a.createElement("img",{src:"/xyz.png",alt:"XYZ",className:"logo"}),"XYZ: Implementing GNAP")),a.createElement("nav",null,o.map((function(e){return a.createElement(i.rU,{to:e.link},a.createElement("span",null,"Â»")," ",e.name)})))),a.createElement("div",{class:"subnav"}))},s=function(e){var t=e.children;return a.createElement(a.Fragment,null,a.createElement(r,null),a.createElement("div",{style:{margin:"0 auto",maxWidth:960,padding:"0px 1.0875rem 1.45rem",paddingTop:0}},t))}}}]);
//# sourceMappingURL=component---src-pages-interaction-mdx-0eafa9a03ff8d5c0c96c.js.map